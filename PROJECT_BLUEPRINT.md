# Midnight Media Studio: Project Blueprint & Stack Architecture

This document serves as the master reference for the **Midnight Media Studio** stack. It is designed to help both humans and AI agents understand, replicate, and deploy this project or similar ones using our optimized infrastructure.

## üèó Core Tech Stack
- **Framework**: [Next.js 15](https://nextjs.org/) (App Router)
- **Language**: TypeScript (Strict Mode)
- **Styling**: Tailwind CSS
- **Runtime**: [Cloudflare Workers / Edge Runtime](https://developers.cloudflare.com/pages/framework-guides/deploy-a-nextjs-site/)
- **Package Manager**: npm (with `legacy-peer-deps=true` configuration)

## üåê Infrastructure & Cloudflare Services
All resources are hosted on the Cloudflare global network for maximum performance and low latency.

### 1. Hosting: Cloudflare Pages
- **Deployment Method**: Direct Upload via `wrangler` (CI/CD).
- **Build Output**: `.vercel/output/static` (Generated by `@cloudflare/next-on-pages`).
- **Compatibility Flag**: `nodejs_compat`.

### 2. Database: Cloudflare D1
- **Engine**: SQLite (Edge-compatible).
- **Binding Name**: `DB`.
- **Migration Path**: `./migrations` directory using standard SQL.

### 3. Storage: Cloudflare R2
- **Standard**: S3-compatible object storage.
- **Binding Name**: `STORAGE`.
- **Usage**: Handling file uploads (images, PDFs) directly from Edge API routes.

---

## üöÄ CI/CD Pipeline (GitHub Actions)
Deployments are handled exclusively via GitHub Actions to ensure a clean build environment.

- **Workflow**: `.github/workflows/deploy.yml`
- **Secrets Required**: 
  - `CLOUDFLARE_API_TOKEN`: Scope with Pages (Edit), D1 (Edit), R2 (Edit).
  - `CLOUDFLARE_ACCOUNT_ID`: Your Cloudflare account identifier.
- **Rules**:
  - Pushes to `main` go to **Production**.
  - Pushes to other branches (or PRs) create **Preview** deployments.

---

## üõ† Project Configuration Details

### `wrangler.toml` (Template)
Always use array syntax for D1 and R2 to support multiple bindings if needed.
```toml
name = "project-name"
pages_build_output_dir = ".vercel/output/static"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

[[d1_databases]]
binding = "DB"
database_name = "your-db-name"
database_id = "your-uuid"

[[r2_buckets]]
binding = "STORAGE"
bucket_name = "your-bucket-name"
```

### `src/lib/cloudflare.ts` (The Bridge)
This utility allows accessing Cloudflare bindings within Next.js components and API routes.
```typescript
import { getRequestContext } from '@cloudflare/next-on-pages';

export function getPlatform() {
  const context = getRequestContext();
  return {
    db: context.env.DB as D1Database,
    storage: context.env.STORAGE as R2Bucket,
    env: context.env,
  };
}
```

---

## ‚ö°Ô∏è Performance Optimization Standards
To maintain 100/100 Lighthouse scores, follow these rules:

1.  **Image Optimization**: Use `sharp` to pre-process images before committing them to `/public`. Aim for < 100KB per full-width image.
2.  **Edge Runtime**: Always export `export const runtime = 'edge';` in API routes and server components using D1/R2.
3.  **Modern Formats**: Configure `next.config.js` to support `image/avif` and `image/webp`.

---

## üìñ New Project Quick-Start (AI Instructions)
If you are an AI starting a new project based on this blueprint:
1.  Initialize Next.js 15 with App Router and Tailwind.
2.  Install `@cloudflare/next-on-pages` and `wrangler`.
3.  Set `legacy-peer-deps=true` in `.npmrc`.
4.  Implement the `getPlatform()` utility in `src/lib/cloudflare.ts`.
5.  Create a `wrangler.toml` using the template above.
6.  Setup the `.github/workflows/deploy.yml` for CI/CD.
7.  Ensure all API routes point to `runtime = 'edge'`.
